# ğŸš€ Declarative Database Schema Rule

**Installation Date:** October 23, 2025  
**Status:** âœ… **COMPLETE & ACTIVE**

---

## ğŸ“¦ What Was Installed

### **1 Comprehensive Rule File | 495 Lines | Mandatory**

Located in: `/home/sk/skybox/skybox-gamehub/.cursor/rules/supabase-declarative-schema.mdc`

---

## ğŸ“‹ Rule Overview

| Property | Details |
|----------|---------|
| File Name | `supabase-declarative-schema.mdc` |
| Size | 495 lines |
| Type | Mandatory database schema management |
| Status | ğŸŸ¢ ACTIVE |
| Compliance | Required for all schema work |

---

## ğŸ¯ What This Rule Covers

### âœ… Exclusive Declarative Schema Approach
- All schema in `supabase/schemas/` directory
- Auto-generated migrations (never manual edits)
- Clear separation of concerns
- Version-controlled schema definitions

### âœ… Schema Declaration Standards
- File location and naming conventions
- Numeric prefixes for execution order (01_, 02_, etc.)
- Complete entity definitions
- Dependency management

### âœ… Migration Generation Workflow
- **Step 1:** Stop Supabase before diffing
- **Step 2:** Generate migrations with `supabase db diff`
- **Step 3:** Review generated migrations carefully
- **Step 4:** Apply and test locally
- **Step 5:** Deploy to production

### âœ… Schema Organization & Dependencies
- Dependency graphs for table creation order
- Foreign key management
- Table execution order strategies
- Column addition patterns

### âœ… Rollback Procedures
- Reverting schema changes safely
- Data-only rollbacks (INSERT, UPDATE, DELETE)
- Testing rollback procedures
- Verification steps

### âœ… Known Caveats & Limitations
- DML statements (INSERT, UPDATE, DELETE) not auto-tracked
- View ownership and permissions
- RLS policy modifications (ALTER POLICY)
- Schema privileges and comments
- Manual migration solutions

### âœ… Complete Workflow Example
- Step-by-step schema changes
- Real SQL code examples
- Command sequences
- Verification procedures

---

## ğŸ” Mandatory Compliance

### Critical Rules
```
âš ï¸  MANDATORY - Non-compliance leads to:
    âœ— Inconsistent database states
    âœ— Lost schema history
    âœ— Deployment failures
    âœ— Data integrity issues
```

### Compliance Checklist
- [ ] All schema in `supabase/schemas/` directory
- [ ] Never manually edit `supabase/migrations/` files
- [ ] Stop Supabase before running `supabase db diff`
- [ ] Review generated migrations before applying
- [ ] Test migrations locally first
- [ ] Handle known caveats appropriately
- [ ] Use numeric prefixes for file ordering

---

## ğŸ“Š Key Concepts

### Declarative vs Imperative

**âœ… DECLARATIVE (Correct Approach)**
```
1. Edit: supabase/schemas/03_games.sql
2. Define: Complete final table state
3. Run: supabase db diff -f add_column
4. Review: supabase/migrations/TIMESTAMP_add_column.sql
5. Apply: supabase start
```

**âŒ IMPERATIVE (Incorrect - Prohibited)**
```
1. Manually write: supabase/migrations/...sql
2. Write: ALTER TABLE statement
3. Apply: Directly run migration
4. Skip: Schema declaration
```

### Table Execution Order

```
01_extensions.sql (if needed)
    â†“
02_enums.sql (custom types)
    â†“
03_leagues.sql (no dependencies)
    â†“
04_teams.sql (foreign key â†’ leagues)
    â†“
05_games.sql (foreign keys â†’ teams, leagues)
    â†“
06_users.sql (no dependencies)
    â†“
07_reservations.sql (foreign keys â†’ users, games)
    â†“
08_functions.sql (operate on tables)
    â†“
09_triggers.sql (reference functions)
```

---

## ğŸš€ Workflow Commands

### Stop Environment
```bash
supabase stop
```

### Declare Schema
```bash
vim supabase/schemas/03_games.sql
# Edit complete entity definition
```

### Generate Migration
```bash
supabase db diff -f add_broadcast_url_column
# Creates: supabase/migrations/TIMESTAMP_add_broadcast_url_column.sql
```

### Start Environment
```bash
supabase start
```

### Verify Schema
```bash
supabase db pull
# Compare with schema declarations
```

### Test Migration
```bash
supabase migration test
```

---

## ğŸ“ Directory Structure

### Required Organization
```
supabase/
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ 01_extensions.sql
â”‚   â”œâ”€â”€ 02_enums.sql
â”‚   â”œâ”€â”€ 03_leagues.sql
â”‚   â”œâ”€â”€ 04_teams.sql
â”‚   â”œâ”€â”€ 05_games.sql
â”‚   â”œâ”€â”€ 06_users.sql
â”‚   â”œâ”€â”€ 07_reservations.sql
â”‚   â”œâ”€â”€ 08_functions.sql
â”‚   â””â”€â”€ 09_triggers.sql
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ (Auto-generated by CLI)
â””â”€â”€ functions/
    â””â”€â”€ (Edge Functions)
```

---

## ğŸ’¡ Key Rules

### File Naming
- Use **numeric prefixes** (01_, 02_, etc.)
- Order by **dependencies**, not alphabetically
- Names should be **descriptive** (e.g., `03_games.sql`)

### Column Addition
- **Always append** new columns to end of table
- Never insert in middle of column definitions
- Minimizes unnecessary diffs

### Known Caveats - Workarounds

| Issue | Solution |
|-------|----------|
| DML not tracked | Add manually to migrations |
| View ownership | Create views in migrations |
| RLS policy changes | Drop and recreate in schema |
| Schema privileges | Write migrations manually |
| Comments | Add manually to migrations |

---

## ğŸ“ When This Rule Applies

Cursor automatically applies this rule when:
- âœ… Working on `supabase/schemas/*.sql` files
- âœ… Reviewing `supabase/migrations/*.sql` files
- âœ… Discussing database schema changes
- âœ… Creating new tables or columns

---

## ğŸ“š Integration with Other Rules

Works alongside these existing rules:

| Rule | Integration |
|------|-------------|
| `create-db-functions.mdc` | Functions defined in schemas/ |
| `create-migration.mdc` | Migration standards & naming |
| `create-rls-policies.mdc` | RLS policies in schemas/ |
| `postgres-sql-style-guide.mdc` | SQL formatting in schemas/ |

---

## âœ¨ Best Practices

### DO âœ…
- Keep schema files in `supabase/schemas/`
- Use numeric prefixes for execution order
- Declare complete final state in schema files
- Stop Supabase before running `db diff`
- Review generated migrations carefully
- Test migrations locally first
- Use descriptive migration names
- Append new columns to end of definitions

### DON'T âŒ
- Manually edit migration files
- Use migrations for schema (use schema declarations)
- Run `db diff` while Supabase is running
- Modify schema files incrementally
- Insert columns in middle of definitions
- Forget to handle known caveats
- Deploy untested migrations

---

## ğŸ”§ Troubleshooting

### Migration doesn't capture all changes
- Verify schema files have complete definitions
- Check file naming order (01_, 02_, etc.)
- Ensure Supabase stopped before `db diff`
- Check for known caveats (RLS, views, etc.)

### Diff shows unexpected changes
- Review schema files for modifications
- Check existing database state: `supabase db pull`
- Verify column order and types

### RLS policies not in migration
- RLS policies may not be fully tracked
- Manually add to schema file or migration
- Test policies after applying migration

### Foreign key constraints failing
- Check table execution order
- Ensure referenced tables exist first
- Verify ON DELETE/ON UPDATE clauses

---

## ğŸ“ Quick Reference

| Task | Command |
|------|---------|
| Stop environment | `supabase stop` |
| Generate migration | `supabase db diff -f <name>` |
| Start environment | `supabase start` |
| Pull schema | `supabase db pull` |
| Test migration | `supabase migration test` |
| Reset database | `supabase db reset` |

---

## ğŸ“– Complete Example Workflow

### 1. Declare Schema
```sql
-- supabase/schemas/03_games.sql
CREATE TABLE IF NOT EXISTS public.games (
  id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  league_id BIGINT NOT NULL REFERENCES public.leagues(id),
  home_team_id BIGINT NOT NULL REFERENCES public.teams(id),
  away_team_id BIGINT NOT NULL REFERENCES public.teams(id),
  game_datetime TIMESTAMP WITH TIME ZONE NOT NULL,
  status TEXT DEFAULT 'scheduled',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_games_datetime ON public.games(game_datetime);
ALTER TABLE public.games ENABLE ROW LEVEL SECURITY;
```

### 2. Generate Migration
```bash
supabase stop
supabase db diff -f create_games_table
```

### 3. Review Migration
```bash
cat supabase/migrations/20241023143000_create_games_table.sql
# Verify all expected SQL is present
```

### 4. Apply & Test
```bash
supabase start
supabase db pull
# Test in dashboard
```

### 5. Add Column Later
```sql
-- Update supabase/schemas/03_games.sql
CREATE TABLE IF NOT EXISTS public.games (
  -- ... existing columns ...
  broadcast_url TEXT,  -- NEW - at end
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

```bash
supabase stop
supabase db diff -f add_broadcast_url
supabase start
```

---

## ğŸ¯ Success Indicators

After implementing this rule, you should have:

âœ… Version-controlled database schema
âœ… Consistent migration naming
âœ… Proper table execution order
âœ… Documented dependencies
âœ… Safe rollback procedures
âœ… Team-wide standardization
âœ… Production-ready database changes

---

## ğŸ“Š Statistics

- **Rule File:** supabase-declarative-schema.mdc
- **Size:** 495 lines
- **Coverage:** Complete schema management workflow
- **Type:** Mandatory/Production-Critical
- **Status:** ğŸŸ¢ Active and Enforced

---

**Installation Date:** October 23, 2025  
**Status:** ğŸŸ¢ ACTIVE & MANDATORY  
**Compliance:** REQUIRED

